{
  "metadata": {
    "name": "admin_{{ item.name | lower }}",
    "displayName": "{{ item.name | lower }} - admin user",
    "description": "Generated by CMP"
  },
  "desiredState": {
    "ingress": {
      "uris": {},
      "gatewayRefs": [
        {
          "ref": "/services/environments/env_{{extra_nginx_controller_environment | lower}}/gateways/gw_{{extra_vmss_name | lower}}"
        }
      ]
    },
    "backend": {
      "ntlmAuthentication": "DISABLED",
      "preserveHostHeader": "ENABLED",
      "workloadGroups": {
        "wlg_{{ item.name | lower }}": {
          "loadBalancingMethod": {
            "type": "LEAST_CONNECTIONS"
          },
          "sessionPersistence": {
            "type": "COOKIE"
          },
          "uris": {
            {%- for workload in item.workloads -%}
            "{{ workload }}": {
              "isBackup": false,
              "isDown": false,
              "isDrain": false
            }{%- if not loop.last -%},{% endif %}
            {%- endfor -%}
          }
        }
      }
    },
    "logging": {
      "errorLog": "DISABLED",
      "accessLog": {
        "state": "DISABLED"
      }
    },
    "security": {
      "rateLimits": {
        "policy_1": {
          "rate": "100r/m",
          "burstBeforeDelay": 0,
          "statusCode": 429,
          "key": "$request_uri_path"
        }
      },
      "identityProviderRefs": [
        {%- for idp in item.identityProviders -%}
        {"ref": "/security/identity-providers/idp_{{idp}}_issue"}
        {%- if not loop.last -%},{% endif %}
        {%- endfor -%}
       ],
      "jwtClientAuth": {
        "keyLocation": "BEARER"
      },
      "conditionalAuthPolicies": {
        "allow_admin": {
          "sourceType": "JWT_CLAIM",
          "sourceKey": "scp",
          "comparisonType": "CONTAINS",
          "comparisonValues": ["admin"],
          "action": "ALLOW",
          "denyStatusCode": 503
        }
      }
    },
    "publishedApiRefs": [
      {
        "ref": "/services/environments/env_{{ extra_nginx_controller_environment | lower }}/apps/app_{{extra_app.name | lower}}.{{extra_app.domain | lower}}/published-apis/api_{{ item.name | lower }}"
      }
    ]
  }
}